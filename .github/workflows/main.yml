name: Main CI

on:
  push:
    branches: [main]
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-deps:
    uses: ./.github/workflows/build.yml
    secrets:
      BACKUP_SECRET_KEY: ${{ secrets.BACKUP_SECRET_KEY }}
      FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
      FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
      FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
      FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
      FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}

  # web-deploy:
  #   if: github.ref_type == 'branch'
  #   needs: build-deps
  #   uses: ./.github/workflows/web.yml

  android-debug:
    if: github.ref_type == 'branch'
    needs: build-deps
    uses: ./.github/workflows/android-debug.yml
    secrets:
      FIREBASE_JSON: ${{ secrets.FIREBASE_JSON_DEBUG }}

  android-release:
    if: github.ref_type == 'tag'
    needs: build-deps
    uses: ./.github/workflows/android-release.yml
    secrets: 
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      FIREBASE_JSON: ${{ secrets.FIREBASE_JSON }}